!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("routine",[],e):"object"==typeof exports?exports.routine=e():t.routine=e()}(this,function(){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return t[n].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e,r){var n=Promise.resolve(r),o=!0,a=!1,s=void 0;try{for(var u,f=function(){var e=u.value;n=n.then(function(r){return t.invoke({operation:e,args:r})})},c=e[Symbol.iterator]();!(o=(u=c.next()).done);o=!0)f()}catch(l){a=!0,s=l}finally{try{!o&&c["return"]&&c["return"]()}finally{if(a)throw s}}return n=n["catch"](function(e){return t.handlers.error?(t.abort(),new Promise(function(r){i.handleError(t,e),r()})):Promise.reject(e)})}Object.defineProperty(e,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},a=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),i=function(){function t(e){r(this,t),this.aborted=!1,this.operations=[],this.handlers={},this.currentOperation=void 0,this.isSynchronous=!0,this.metadata=new Map,this.scope=e||{},this.scope.routine=this}return a(t,[{key:"addOperation",value:function(e,r){return t.validateOperation(e),this.addOperationInstanceMetadata(e,r),this.operations.push(e),this}},{key:"addOperationInstanceMetadata",value:function(t,e){if(!this.metadata.has(t)){var r={instance:{},"static":{}};this.metadata.set(t,r)}if(e){if("object"!==("undefined"==typeof e?"undefined":o(e)))throw new Error("Instance metadata must be an object - Instance metadata was "+("specified for an operation named "+t.name+" but the instance metadata was ")+("of type "+("undefined"==typeof t?"undefined":o(t))+". Instance metadata must however be an object"));this.metadata.get(t).instance=e}}},{key:"first",value:function(t,e){return this.addOperation(t,e),this}},{key:"then",value:function(t,e){return this.addOperation(t,e),this}},{key:"on",value:function(e,r){var n=this;return t.validateOperation(r),this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(function(t){return r.call(n.scope,t)}),this}},{key:"use",value:function(t){return t(this),this}},{key:"abort",value:function(){this.aborted=!0}},{key:"invoke",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=e.operation,n=e.args,o=e.hasMultipleArgs,a=void 0!==o&&o,i=e.respectAbort,s=void 0===i||i,u=e.recordIt,f=void 0===u||u,c=e.runHandlers,l=void 0===c||c,d={operation:r,args:n,hasMultipleArgs:a,respectAbort:s,recordIt:f,runHandlers:l};if(d.runHandlers&&this.handlers["before-invoking-operation"]){var h=!0,p=!1,v=void 0;try{for(var y,b=this.handlers["before-invoking-operation"][Symbol.iterator]();!(h=(y=b.next()).done);h=!0){var m=y.value;m(d)}}catch(k){p=!0,v=k}finally{try{!h&&b["return"]&&b["return"]()}finally{if(p)throw v}}}if(!d.respectAbort||!this.aborted){d.recordIt&&(this.currentOperation=d.operation);var g=void 0;if(g=t.isRunnable(d.operation)?d.operation.run(this):d.hasMultipleArgs?d.operation.apply(this.scope,d.args):d.operation.call(this.scope,d.args),l&&this.handlers["after-invoking-operation"]){var w=!0,O=!1,x=void 0;try{for(var A,I=this.handlers["after-invoking-operation"][Symbol.iterator]();!(w=(A=I.next()).done);w=!0){var S=A.value;S({operation:r,args:n,hasMultipleArgs:a,respectAbort:s,recordIt:f,result:g})}}catch(k){O=!0,x=k}finally{try{!w&&I["return"]&&I["return"]()}finally{if(O)throw x}}}return g}}},{key:"run",value:function(){var e=void 0;try{for(var r=0;r<this.operations.length;r++){var o=this.operations[r];if(e=this.invoke({operation:o,args:e}),e instanceof Promise){this.isSynchronous=!1;var a=this.operations.slice(r+1,this.operations.length);return n(this,a,e)}}return e}catch(i){t.handleError(this,i)}}},{key:"set",value:function(t){for(var e in t)t.hasOwnProperty(e)&&(this.scope[e]=t[e]);return this}},{key:"setup",get:function(){return{as:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var o=!0,a=!1,i=void 0;try{for(var s,u=r[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var f=s.value;t.validateOperation(f),this.invoke({operation:f,args:this,respectAbort:!1,runAspects:!1})}}catch(c){a=!0,i=c}finally{try{!o&&u["return"]&&u["return"]()}finally{if(a)throw i}}}}}},{key:"and",get:function(){return this}},{key:"but",get:function(){return this}}],[{key:"use",value:function(e){var r=new t;return r.use(e),r}},{key:"set",value:function(e){return new t(e)}},{key:"isRunnable",value:function(t){return"object"===("undefined"==typeof t?"undefined":o(t))&&void 0!==t.run}},{key:"validateOperation",value:function(e){if(!t.isRunnable(e)&&"function"!=typeof e)throw new Error("Invalid operation type - An operation has to either be a function or an object with a `run()` method. Instead an operation of type "+("'"+("undefined"==typeof e?"undefined":o(e))+"' was supplied."))}},{key:"handleError",value:function(t,e){if(e.$state=t.scope.state,e.$invocation={operation:t.currentOperation?t.currentOperation.name:"unknown operation"},t.handlers.error){var r=!0,n=!1,o=void 0;try{for(var a,i=t.handlers.error[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var s=a.value;t.invoke({operation:s,args:e,recordIt:!1,respectAbort:!1})}}catch(u){n=!0,o=u}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw o}}}else if(t.isSynchronous)throw e}}]),t}();e["default"]=i,t.exports=e["default"]}])});
//# sourceMappingURL=Routine.min.js.map