!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("routine",[],e):"object"==typeof exports?exports.routine=e():t.routine=e()}(this,function(){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return t[n].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e,r){var n=Promise.resolve(r),o=!0,a=!1,s=void 0;try{for(var u,l=function(){var e=u.value;n=n.then(function(r){return t.invoke({operation:e,args:r})})},f=e[Symbol.iterator]();!(o=(u=f.next()).done);o=!0)l()}catch(c){a=!0,s=c}finally{try{!o&&f["return"]&&f["return"]()}finally{if(a)throw s}}return n=n["catch"](function(e){return t.handlers.error?(t.abort(),new Promise(function(r){i.handleError(t,e),r()})):Promise.reject(e)})}Object.defineProperty(e,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},a=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),i=function(){function t(e){r(this,t),this.aborted=!1,this.handlers={"run:before":[],"invocation:before":[],"invocation:after":[]},this.metadata=new Map,this.operations=[],this.isSynchronous=!0,this.lastConditionMet=void 0,this.currentOperation=void 0,this.scope=e||{},this.scope.routine=this}return a(t,[{key:"addOperation",value:function(e,r){t.validateOperation(e);var n=Object.assign(e["@routine.metadata"]||{},r||{});return this.addOperationInstanceMetadata(e,n),this.operations.push(e),this}},{key:"addOperationInstanceMetadata",value:function(t,e){if(!this.metadata.has(t)){var r={instance:{},"static":{}};this.metadata.set(t,r)}if(e){if("object"!==("undefined"==typeof e?"undefined":o(e)))throw new Error("Instance metadata must be an object - Instance metadata was "+("specified for an operation named "+t.name+" but the instance metadata was ")+("of type "+("undefined"==typeof t?"undefined":o(t))+". Instance metadata must however be an object"));this.metadata.get(t).instance=e}}},{key:"first",value:function(t,e){return this.addOperation(t,e),this}},{key:"then",value:function(t,e){return this.addOperation(t,e),this}},{key:"otherwise",value:function(t,e){var r=this;this.addOperationInstanceMetadata(t,e);var n=function(e){return r.lastConditionMet?void r.abort():r.invoke({operation:t,args:e})};return this.addOperation(n),this}},{key:"on",value:function(e,r){return t.validateOperation(r),this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(r),this}},{key:"use",value:function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var n=!0,a=!1,i=void 0;try{for(var s,u=e[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var l=s.value;"function"==typeof l?l(this):"object"===("undefined"==typeof l?"undefined":o(l))&&this.setScopeTo(l)}}catch(f){a=!0,i=f}finally{try{!n&&u["return"]&&u["return"]()}finally{if(a)throw i}}return this}},{key:"abort",value:function(){this.aborted=!0}},{key:"invoke",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=e.operation,n=e.args,o=e.isConstructor,a=void 0!==o&&o,i=e.hasMultipleArgs,s=void 0!==i&&i,u=e.respectAbort,l=void 0===u||u,f=e.recordIt,c=void 0===f||f,d=e.runHandlers,h=void 0===d||d,p=e.scope,v=void 0===p?this.scope:p,y={operation:r,args:n,isConstructor:a,hasMultipleArgs:s,respectAbort:l,recordIt:c,runHandlers:h,scope:v};if(y.runHandlers&&this.handlers["invocation:before"]){var b=!0,m=!1,g=void 0;try{for(var w,k=this.handlers["invocation:before"][Symbol.iterator]();!(b=(w=k.next()).done);b=!0){var O=w.value;O(y)}}catch(x){m=!0,g=x}finally{try{!b&&k["return"]&&k["return"]()}finally{if(m)throw g}}}if(!y.respectAbort||!this.aborted){y.recordIt&&(this.currentOperation=y.operation);var A=void 0;if(t.isRunnable(y.operation)?A=y.operation.run(this,y.args):a?y.hasMultipleArgs?(y.args.unshift(null),A=new(y.operation.bind.apply(y.operation,y.args))):A=new y.operation(y.args):A=y.hasMultipleArgs?y.operation.apply(y.scope,y.args):y.operation.call(y.scope,y.args),h&&this.handlers["invocation:after"]){var S=!0,j=!1,I=void 0;try{for(var M,P=this.handlers["invocation:after"][Symbol.iterator]();!(S=(M=P.next()).done);S=!0){var E=M.value;E({operation:r,args:n,hasMultipleArgs:s,respectAbort:l,recordIt:c,result:A})}}catch(x){j=!0,I=x}finally{try{!S&&P["return"]&&P["return"]()}finally{if(j)throw I}}}return A}}},{key:"emit",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];var o=!0,a=!1,i=void 0;try{for(var s,u=this.handlers[t][Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var l=s.value;l.apply(null,r)}}catch(f){a=!0,i=f}finally{try{!o&&u["return"]&&u["return"]()}finally{if(a)throw i}}}},{key:"run",value:function(){this.emit("run:before");var e=void 0;try{for(var r=0;r<this.operations.length;r++){var o=this.operations[r];if(e=this.invoke({operation:o,args:e}),e instanceof Promise){this.isSynchronous=!1;var a=this.operations.slice(r+1,this.operations.length);return n(this,a,e)}}return e}catch(i){t.handleError(this,i)}}},{key:"setScopeTo",value:function(t){for(var e in t)"@routine.use"===e?this.use.apply(this,t[e]):"routine"!==e&&t.hasOwnProperty(e)&&(this.scope[e]=t[e]);return this}},{key:"setup",get:function(){return{as:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var o=!0,a=!1,i=void 0;try{for(var s,u=r[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var l=s.value;t.validateOperation(l),this.invoke({operation:l,args:this,respectAbort:!1,runAspects:!1})}}catch(f){a=!0,i=f}finally{try{!o&&u["return"]&&u["return"]()}finally{if(a)throw i}}}}}},{key:"and",get:function(){return this}},{key:"but",get:function(){return this}}],[{key:"use",value:function(){for(var e=new t,r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return e.use.apply(e,n),e}},{key:"setScopeTo",value:function(e){return new t(e)}},{key:"isRunnable",value:function(t){return"object"===("undefined"==typeof t?"undefined":o(t))&&void 0!==t.run}},{key:"validateOperation",value:function(e){if(!t.isRunnable(e)&&"function"!=typeof e)throw new Error("Invalid operation type - An operation has to either be a function or an object with a `run()` method. Instead an operation of type "+("'"+("undefined"==typeof e?"undefined":o(e))+"' was supplied."))}},{key:"handleError",value:function(t,e){if(t.scope.error=e,e.$invocation={operation:t.currentOperation?t.currentOperation.name:"unknown operation"},t.handlers.error){var r=!0,n=!1,o=void 0;try{for(var a,i=t.handlers.error[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var s=a.value;t.invoke({operation:s,args:e,recordIt:!1,respectAbort:!1})}}catch(u){n=!0,o=u}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw o}}}else if(t.isSynchronous)throw e}}]),t}();e["default"]=i,t.exports=e["default"]}])});
//# sourceMappingURL=Routine.min.js.map