!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("routine",[],t):"object"==typeof exports?exports.routine=t():e.routine=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t,r){var n=Promise.resolve(r),o=!0,a=!1,s=void 0;try{for(var u,c=function(){var t=u.value;n=n.then(function(r){return e.invoke({operation:t,args:r})})},f=t[Symbol.iterator]();!(o=(u=f.next()).done);o=!0)c()}catch(l){a=!0,s=l}finally{try{!o&&f["return"]&&f["return"]()}finally{if(a)throw s}}return n=n["catch"](function(t){return e.handlers.error?(e.abort(),new Promise(function(r){i.handleError(e,t),r()})):Promise.reject(t)})}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){r(this,e),this.aborted=!1,this.operations=[],this.handlers={},this.currentOperation=void 0,this.isSynchronous=!0,this.metadata=new Map,this.scope=t||{},this.scope.routine=this}return a(e,[{key:"addOperation",value:function(t,r){return e.validateOperation(t),this.addOperationInstanceMetadata(t,r),this.operations.push(t),this}},{key:"addOperationInstanceMetadata",value:function(e,t){if(!this.metadata.has(e)){var r={instance:{},"static":{}};this.metadata.set(e,r)}if(t){if("object"!==("undefined"==typeof t?"undefined":o(t)))throw new Error("Instance metadata must be an object - Instance metadata was "+("specified for an operation named "+e.name+" but the instance metadata was ")+("of type "+("undefined"==typeof e?"undefined":o(e))+". Instance metadata must however be an object"));this.metadata.get(e).instance=t}}},{key:"first",value:function(e,t){return this.addOperation(e,t),this}},{key:"then",value:function(e,t){return this.addOperation(e,t),this}},{key:"on",value:function(t,r){var n=this;return e.validateOperation(r),this.handlers[t]||(this.handlers[t]=[]),this.handlers[t].push(function(e){return r.call(n.scope,e)}),this}},{key:"use",value:function(e){return e(this),this}},{key:"abort",value:function(){this.aborted=!0}},{key:"invoke",value:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=t.operation,n=t.args,o=t.hasMultipleArgs,a=void 0!==o&&o,i=t.respectAbort,s=void 0===i||i,u=t.recordIt,c=void 0===u||u,f=t.runHandlers,l=void 0===f||f,d={operation:r,args:n,hasMultipleArgs:a,respectAbort:s,recordIt:c,runHandlers:l};if(d.runHandlers&&this.handlers["before-invoking-operation"]){var h=!0,p=!1,v=void 0;try{for(var y,b=this.handlers["before-invoking-operation"][Symbol.iterator]();!(h=(y=b.next()).done);h=!0){var m=y.value;m(d)}}catch(k){p=!0,v=k}finally{try{!h&&b["return"]&&b["return"]()}finally{if(p)throw v}}}if(!d.respectAbort||!this.aborted){d.recordIt&&(this.currentOperation=d.operation);var g=void 0;if(g=e.isRunnable(d.operation)?d.operation.run(this):d.hasMultipleArgs?d.operation.apply(this.scope,d.args):d.operation.call(this.scope,d.args),l&&this.handlers["after-invoking-operation"]){var w=!0,O=!1,x=void 0;try{for(var S,A=this.handlers["after-invoking-operation"][Symbol.iterator]();!(w=(S=A.next()).done);w=!0){var I=S.value;I({operation:r,args:n,hasMultipleArgs:a,respectAbort:s,recordIt:c,result:g})}}catch(k){O=!0,x=k}finally{try{!w&&A["return"]&&A["return"]()}finally{if(O)throw x}}}return g}}},{key:"run",value:function(){var t=void 0;try{for(var r=0;r<this.operations.length;r++){var o=this.operations[r];if(t=this.invoke({operation:o,args:t}),t instanceof Promise){this.isSynchronous=!1;var a=this.operations.slice(r+1,this.operations.length);return n(this,a,t)}}return t}catch(i){e.handleError(this,i)}}},{key:"setScopeTo",value:function(e){for(var t in e)e.hasOwnProperty(t)&&(this.scope[t]=e[t]);return this}},{key:"setup",get:function(){return{as:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var o=!0,a=!1,i=void 0;try{for(var s,u=r[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var c=s.value;e.validateOperation(c),this.invoke({operation:c,args:this,respectAbort:!1,runAspects:!1})}}catch(f){a=!0,i=f}finally{try{!o&&u["return"]&&u["return"]()}finally{if(a)throw i}}}}}},{key:"and",get:function(){return this}},{key:"but",get:function(){return this}}],[{key:"use",value:function(t){var r=new e;return r.use(t),r}},{key:"setScopeTo",value:function(t){return new e(t)}},{key:"isRunnable",value:function(e){return"object"===("undefined"==typeof e?"undefined":o(e))&&void 0!==e.run}},{key:"validateOperation",value:function(t){if(!e.isRunnable(t)&&"function"!=typeof t)throw new Error("Invalid operation type - An operation has to either be a function or an object with a `run()` method. Instead an operation of type "+("'"+("undefined"==typeof t?"undefined":o(t))+"' was supplied."))}},{key:"handleError",value:function(e,t){if(t.$state=e.scope.state,t.$invocation={operation:e.currentOperation?e.currentOperation.name:"unknown operation"},e.handlers.error){var r=!0,n=!1,o=void 0;try{for(var a,i=e.handlers.error[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var s=a.value;e.invoke({operation:s,args:t,recordIt:!1,respectAbort:!1})}}catch(u){n=!0,o=u}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw o}}}else if(e.isSynchronous)throw t}}]),e}();t["default"]=i,e.exports=t["default"]}])});
//# sourceMappingURL=Routine.min.js.map