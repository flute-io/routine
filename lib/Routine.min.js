!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("routine",[],t):"object"==typeof exports?exports.routine=t():e.routine=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t,r){var n=Promise.resolve(r),o=!0,i=!1,s=void 0;try{for(var u,c=function(){var t=u.value;n=n.then(function(r){return e.invoke({operation:t,args:r})})},f=t[Symbol.iterator]();!(o=(u=f.next()).done);o=!0)c()}catch(l){i=!0,s=l}finally{try{!o&&f["return"]&&f["return"]()}finally{if(i)throw s}}return n=n["catch"](function(t){return e.handlers.error?(e.abort(),new Promise(function(r){a.handleError(e,t),r()})):Promise.reject(t)})}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t){r(this,e),this.aborted=!1,this.operations=[],this.handlers={},this.currentOperation=void 0,this.isSynchronous=!0,this.metadata=new Map,this.scope=t||{},this.scope.routine=this}return i(e,[{key:"addOperation",value:function(t,r){return e.validateOperation(t),this.addOperationInstanceMetadata(t,r),this.operations.push(t),this}},{key:"addOperationInstanceMetadata",value:function(e,t){if(!this.metadata.has(e)){var r={instance:{},"static":{}};this.metadata.set(e,r)}if(t){if("object"!==("undefined"==typeof t?"undefined":o(t)))throw new Error("Instance metadata must be an object - Instance metadata was "+("specified for an operation named "+e.name+" but the instance metadata was ")+("of type "+("undefined"==typeof e?"undefined":o(e))+". Instance metadata must however be an object"));this.metadata.get(e).instance=t}}},{key:"first",value:function(e,t){return this.addOperation(e,t),this}},{key:"then",value:function(e,t){return this.addOperation(e,t),this}},{key:"on",value:function(t,r){var n=this;return e.validateOperation(r),this.handlers[t]||(this.handlers[t]=[]),this.handlers[t].push(function(e){return r.call(n.scope,e)}),this}},{key:"use",value:function(e){return e(this),this}},{key:"abort",value:function(){this.aborted=!0}},{key:"invoke",value:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=t.operation,n=t.args,o=t.isConstructor,i=void 0!==o&&o,a=t.hasMultipleArgs,s=void 0!==a&&a,u=t.respectAbort,c=void 0===u||u,f=t.recordIt,l=void 0===f||f,p=t.runHandlers,d=void 0===p||p,h=t.scope,v=void 0===h?this.scope:h,y={operation:r,args:n,hasMultipleArgs:s,respectAbort:c,recordIt:l,runHandlers:d,scope:v};if(y.runHandlers&&this.handlers["before-invoking-operation"]){var b=!0,m=!1,g=void 0;try{for(var k,w=this.handlers["before-invoking-operation"][Symbol.iterator]();!(b=(k=w.next()).done);b=!0){var O=k.value;O(y)}}catch(x){m=!0,g=x}finally{try{!b&&w["return"]&&w["return"]()}finally{if(m)throw g}}}if(!y.respectAbort||!this.aborted){y.recordIt&&(this.currentOperation=y.operation);var A=void 0;if(e.isRunnable(y.operation)?A=y.operation.run(this):i?y.hasMultipleArgs?(y.args.unshift(null),A=new(y.operation.bind.apply(y.operation,y.args))):A=new y.operation(y.args):A=y.hasMultipleArgs?y.operation.apply(y.scope,y.args):y.operation.call(y.scope,y.args),d&&this.handlers["after-invoking-operation"]){var S=!0,I=!1,j=void 0;try{for(var M,P=this.handlers["after-invoking-operation"][Symbol.iterator]();!(S=(M=P.next()).done);S=!0){var E=M.value;E({operation:r,args:n,hasMultipleArgs:s,respectAbort:c,recordIt:l,result:A})}}catch(x){I=!0,j=x}finally{try{!S&&P["return"]&&P["return"]()}finally{if(I)throw j}}}return A}}},{key:"run",value:function(){var t=void 0;try{for(var r=0;r<this.operations.length;r++){var o=this.operations[r];if(t=this.invoke({operation:o,args:t}),t instanceof Promise){this.isSynchronous=!1;var i=this.operations.slice(r+1,this.operations.length);return n(this,i,t)}}return t}catch(a){e.handleError(this,a)}}},{key:"setScopeTo",value:function(e){for(var t in e)e.hasOwnProperty(t)&&(this.scope[t]=e[t]);return this}},{key:"setup",get:function(){return{as:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var o=!0,i=!1,a=void 0;try{for(var s,u=r[Symbol.iterator]();!(o=(s=u.next()).done);o=!0){var c=s.value;e.validateOperation(c),this.invoke({operation:c,args:this,respectAbort:!1,runAspects:!1})}}catch(f){i=!0,a=f}finally{try{!o&&u["return"]&&u["return"]()}finally{if(i)throw a}}}}}},{key:"and",get:function(){return this}},{key:"but",get:function(){return this}}],[{key:"use",value:function(t){var r=new e;return r.use(t),r}},{key:"setScopeTo",value:function(t){return new e(t)}},{key:"isRunnable",value:function(e){return"object"===("undefined"==typeof e?"undefined":o(e))&&void 0!==e.run}},{key:"validateOperation",value:function(t){if(!e.isRunnable(t)&&"function"!=typeof t)throw new Error("Invalid operation type - An operation has to either be a function or an object with a `run()` method. Instead an operation of type "+("'"+("undefined"==typeof t?"undefined":o(t))+"' was supplied."))}},{key:"handleError",value:function(e,t){if(e.scope.error=t,t.$invocation={operation:e.currentOperation?e.currentOperation.name:"unknown operation"},e.handlers.error){var r=!0,n=!1,o=void 0;try{for(var i,a=e.handlers.error[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;e.invoke({operation:s,args:t,recordIt:!1,respectAbort:!1})}}catch(u){n=!0,o=u}finally{try{!r&&a["return"]&&a["return"]()}finally{if(n)throw o}}}else if(e.isSynchronous)throw t}}]),e}();t["default"]=a,e.exports=t["default"]}])});
//# sourceMappingURL=Routine.min.js.map